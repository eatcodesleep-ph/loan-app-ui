@page
@model LoanApp.Web.Pages.Loan.QuotationPageModel
@{
    ViewData["Title"] = "Loan Quotation";
}

<style>
    .readonly .form-control[disabled],
    .readonly .form-control[readonly] {
        background-color: #f6f6f6;
        border-color: #e0e0e0;
        color: #666;
    }

    .edit-toggle-btn {
        border: none;
        background: transparent;
        color: #0d6efd;
        cursor: pointer;
    }

    .slider-value {
        font-weight: 600;
    }

    .range-wrap {
        position: relative;
        width: 100%;
    }

    .range-bubble {
        position: absolute;
        top: -2.2rem;
        left: 0;
        transform: translateX(-50%);
        padding: .25rem .5rem;
        font-size: .875rem;
        color: #fff;
        background: #0d6efd;
        border-radius: .375rem;
        white-space: nowrap;
        pointer-events: none;
    }
    
    /* Small triangle caret */
    .range-bubble::after {
        content: '';
        position: absolute;
        bottom: -6px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 6px 6px 0 6px;
        border-style: solid;
        border-color: #0d6efd transparent transparent transparent;
    }
</style>

<div class="container py-3">
    <h1 class="mb-4">Quote Calculator</h1>

    <form method="post">
        @Html.AntiForgeryToken()

        <input type="hidden" asp-for="ViewModel.IdentityToken" />

        <div id="applicantSection" class="readonly">
            <div class="row g-3">
                <div class="col-md-2">
                    <label asp-for="ViewModel.Title" class="form-label"></label>
                    <select asp-for="ViewModel.Title" class="form-select">
                        <option value="Mr">Mr</option>
                        <option value="Ms">Ms</option>
                        <option value="Mrs">Mrs</option>
                    </select>
                    <span asp-validation-for="ViewModel.Title" class="text-danger"></span>
                </div>
                <div class="col-md-5">
                    <label asp-for="ViewModel.FirstName" class="form-label"></label>
                    <input asp-for="ViewModel.FirstName" class="form-control" />
                    <span asp-validation-for="ViewModel.FirstName" class="text-danger"></span>
                </div>
                <div class="col-md-5">
                    <label asp-for="ViewModel.LastName" class="form-label"></label>
                    <input asp-for="ViewModel.LastName" class="form-control" />
                    <span asp-validation-for="ViewModel.LastName" class="text-danger"></span>
                </div>
                <div class="col-md-4">
                    <label asp-for="ViewModel.DateOfBirth" class="form-label"></label>
                    <input asp-for="ViewModel.DateOfBirth" type="date" class="form-control" />
                </div>
                <div class="col-md-4">
                    <label asp-for="ViewModel.Email" class="form-label"></label>
                    <input asp-for="ViewModel.Email" type="email" class="form-control" placeholder="name@example.com" />
                </div>
                <div class="col-md-4">
                    <label asp-for="ViewModel.MobileNumber" class="form-label"></label>
                    <input asp-for="ViewModel.MobileNumber" class="form-control" inputmode="tel" placeholder="+63 9xx xxx xxxx" />
                </div>
            </div>
        </div>

        <hr class="my-4" />

        <div class="col-md-4">
            <label asp-for="ViewModel.ProductType" class="form-label"></label>
            <select asp-for="ViewModel.ProductType" class="form-select" id="productSelect">
                <option value="ProductA">Product A</option>
                <option value="ProductB">Product B</option>
                <option value="ProductC">Product C</option>
            </select>
            <span asp-validation-for="ViewModel.ProductType" class="text-danger"></span>
        </div>
        <br />
        <div class="row g-3">
                <label class="form-label">Loan Amount</label>

                <div class="range-wrap">
                    <input id="amountRange"
                           type="range"
                           class="form-range"
                           min="@Model.MaxLoanAmountMin"
                           max="@Model.MaxLoanAmount"
                           step="@Model.LoanAmountStep"
                           value="@Model.ViewModel.LoanAmount" />

                    <output id="amountBubble" class="range-bubble">
                    @Model.ViewModel.LoanAmount?.ToString("C")
                    </output>
                </div>

                <div class="d-flex justify-content-between mt-1">
                    <small class="text-muted">@Model.MaxLoanAmountMin.ToString("C")</small>
                    <span class="text-muted">How much do you need?</span>
                    <small class="text-muted">@Model.MaxLoanAmount.ToString("C")</small>
                </div>
                <input type="hidden" asp-for="ViewModel.LoanAmount" />
        </div>
        <br />
        <div class="row g-3">
                <label class="form-label">Term (in Months)</label>
                <div class="range-wrap">
                    <input id="termRange"
                           type="range"
                           class="form-range"
                           min="@Model.MinTermMonths"
                           max="@Model.MaxTermMonths"
                           step="1"
                           value="@Model.ViewModel.TermMonths" />

                    <output id="termBubble" class="range-bubble">
                        @Model.ViewModel.TermMonths @("month" + (@Model.ViewModel.TermMonths == 1 ? "" : "s"))
                    </output>
                </div>

                <div class="d-flex justify-content-between mt-1">
                    <small class="text-muted">
                        Min: <span id="termMinLabel" data-base-min="@Model.MinTermMonths">@Model.MinTermMonths</span>
                    </small>
                    <span class="text-muted">Loan Term Duration</span>
                    <small class="text-muted">@Model.MaxTermMonths</small>
                </div>
            <input type="hidden" asp-for="ViewModel.TermMonths" />
        </div>
        <br />
        <center>
        <div class="row col-md-6">
            <button type="submit" class="btn btn-primary">Calculate Quote</button>
            <small class="text-muted">Quote does not affect your credit score</small>
        </div>
        </center>

        <div class="mt-3">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        (function() {
          const range = document.getElementById('amountRange');
          const bubble = document.getElementById('amountBubble');
          const text = document.getElementById('amountValue');
          const hidden = document.querySelector('input[name="ViewModel.LoanAmount"]');
          const fmt = new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' });

          function setBubble() {
            const min = Number(range.min || 0);
            const max = Number(range.max || 100);
            const val = Number(range.value);
            const percent = (val - min) * 100 / (max - min);
            const label = fmt.format(val);
            bubble.textContent = label;

            const thumbFix = 14;
            bubble.style.left = `calc(${percent}% + (${thumbFix - percent * 0.28}px))`;

            if (text) text.textContent = label;
            if (hidden) hidden.value = val;

            range.setAttribute('aria-valuenow', String(val));
            range.setAttribute('aria-valuetext', label);
          }

          setBubble();
          range.addEventListener('input', setBubble);
        })();
    </script>

    <script>
        function attachTermBubble() {
          const range = document.getElementById('termRange');
          const bubble = document.getElementById('termBubble');
          const text = document.getElementById('termValue');
          const hidden = document.querySelector('input[name="ViewModel.TermMonths"]');

          function label(val) {
            const n = Number(val);
            return `${n} month${n === 1 ? '' : 's'}`;
          }

          function updateBubble() {
            const min = Number(range.min || 0);
            const max = Number(range.max || 100);
            const val = Number(range.value);
            const percent = (val - min) * 100 / (max - min);
            const thumbFix = 14;

            bubble.textContent = label(val);
            bubble.style.left = `calc(${percent}% + (${thumbFix - percent * 0.28}px))`;
            if (text) text.textContent = val;
            if (hidden) hidden.value = val;
            range.setAttribute('aria-valuenow', String(val));
            range.setAttribute('aria-valuetext', label(val));
          }

          updateBubble();
          range.addEventListener('input', updateBubble);

          return { updateBubble, range };
        }

        document.addEventListener('DOMContentLoaded', () => {
          const product = document.getElementById('productSelect');
          const { updateBubble, range } = attachTermBubble();
          const hidden = document.querySelector('input[name="ViewModel.TermMonths"]');
          const absoluteMin = Number(range.getAttribute('min') || 0);
          const productBMin = 6;

          function applyProductRules() {
            const isProductB = product.value === 'ProductB';
            const effectiveMin = isProductB ? Math.max(productBMin, absoluteMin) : absoluteMin;

            range.min = String(effectiveMin);
            if (Number(range.value) < effectiveMin) {
              range.value = String(effectiveMin);
              if (hidden) hidden.value = String(effectiveMin);
            }

            updateBubble();

            if (termMinLabel) {
              termMinLabel.textContent = String(effectiveMin);
            }

          }

          applyProductRules();

          product.addEventListener('change', applyProductRules);
        });
    </script>
}
